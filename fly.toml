# fly.toml
# Nome do aplicativo registrado no Fly.io
[cite_start]app = "tammyclara-store-b2y" [cite: 4]

# Região primária para a máquina virtual
[cite_start]primary_region = "gru" [cite: 4]

[build]
  # Usa o Dockerfile na raiz

# CONFIGURAÇÃO DE VOLUMES: UNIFICADA PARA 1 VOLUME
[[mounts]]
  # O volume único que armazena tanto o db.sqlite3 quanto a pasta /media
  [cite_start]source="tammyclara_data" [cite: 4]
  [cite_start]destination="/app/data"   # O ponto de montagem no contêiner [cite: 4]

[env]
  [cite_start]PORT = "8000" [cite: 4]
  [cite_start]PYTHON_VERSION = "3.11" [cite: 4]

# Configuração para servir a aplicação Web
[[services]]
  [cite_start]protocol = "tcp" [cite: 4]
  [cite_start]internal_port = 8000 [cite: 4]
  [cite_start]processes = ["app"] [cite: 4]

  [[services.ports]]
    [cite_start]port = "80" [cite: 4]
    [cite_start]handlers = ["http"] [cite: 4]
    [cite_start]force_https = true [cite: 4]

  [[services.ports]]
    [cite_start]port = "443" [cite: 4]
    [cite_start]handlers = ["tls", "http"] [cite: 4]

  [[services.http_checks]]
    [cite_start]interval = "10s" [cite: 4]
    [cite_start]grace_period = "5s" [cite: 4]
    # Usando a rota principal '/' para um health check mais rápido e confiável (Corrigido da análise anterior)
    path = "/" 
    [cite_start]timeout = "5s" # Aumentado para 5s [cite: 4]
    [cite_start]tls-skip-verify = false [cite: 4]
    
[deploy]
  # Usa /bin/sh -c para executar os comandos collectstatic e migrate com sucesso.
  release_command = "/bin/sh -c 'python manage.py collectstatic --noinput && python manage.py migrate --noinput'"